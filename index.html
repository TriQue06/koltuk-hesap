<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>✨ Koltuk Hesaplayıcı ✨</title>
  <style>
    /* --- Fontlar: Tümü Product Sans --- */
    @font-face{font-family:'Product Sans';src:url('font/ProductSans-Regular.ttf') format('truetype');font-weight:400;font-style:normal}
    @font-face{font-family:'Product Sans';src:url('font/ProductSans-Medium.ttf')  format('truetype');font-weight:500;font-style:normal}
    @font-face{font-family:'Product Sans';src:url('font/ProductSans-Bold.ttf')    format('truetype');font-weight:700;font-style:normal}
    @font-face{font-family:'Product Sans';src:url('font/ProductSans-Light.ttf')   format('truetype');font-weight:300;font-style:normal}
    *{font-family:'Product Sans',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    button,input,select,textarea{font:inherit}

    /* Varsayılan kök (dark) + ikon filtresi */
    :root{
      --bg-color:#10121a; --card-bg:rgba(18,20,32,.92);
      --primary-color:#6a11cb; --secondary-color:#2575fc;
      --text-color:#f2f3f7; --border-color:rgba(255,255,255,.18);
      --input-bg:rgba(255,255,255,.08); --result-bg:rgba(255,255,255,.05);
      --button-bg:#3a3a58; --button-hover-bg:#4a4a6f;
    }

    /* Light Mode */
    :root.light-mode{
      --light-mode-secondary-text:#000;
      --bg-color:#f7f7fb; --card-bg:rgba(255,255,255,.92);
      --primary-color:#4e54c8; --secondary-color:#8f94fb;
      --text-color:#1a1a1a; --border-color:rgba(0,0,0,.12);
      --input-bg:rgba(0,0,0,.06); --result-bg:rgba(0,0,0,.03);
      --button-bg:#e6e7ef; --button-hover-bg:#d8d9e6;
    }

    body{
      background:var(--bg-color); color:var(--text-color);
      min-height:100vh; display:flex; justify-content:center; align-items:center;
      padding:20px; margin:0; position:relative; transition:background-color .25s,color .25s
    }

    .top-bar{
      position:fixed; top:20px; left:20px; right:20px; z-index:1000;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      pointer-events:none;
    }
    .top-left,.top-right{display:flex; align-items:center; gap:10px; pointer-events:auto}
    .top-btn{
      padding:8px 12px; border-radius:10px; background:var(--button-bg); color:var(--text-color);
      border:1px solid var(--border-color); font-size:.95em; cursor:pointer; transition:background-color .25s, transform .15s;
      position:relative; z-index:1001; display:inline-flex; align-items:center; gap:8px;
    }
    .top-btn:hover{background:var(--button-hover-bg); transform:translateY(-1px)}
    .icon{
      width:18px; height:18px;
    }
    .btn-with-icon{display:inline-flex; align-items:center; gap:8px}

    .threshold-control{display:flex; align-items:center; gap:10px}
    .threshold-input{width:80px; padding:12px; font-size:1.05em; box-sizing:border-box}
    .threshold-button{
      padding:12px; border:1px solid var(--border-color); border-radius:10px; background:var(--input-bg);
      color:var(--text-color); font-weight:600; cursor:pointer; transition:background-color .25s,border-color .25s; font-size:1.05em; width:150px;
      display:inline-flex; align-items:center; gap:8px; justify-content:center;
    }
    .threshold-button.active{background:var(--primary-color); border-color:var(--primary-color); color:#fff}
    .threshold-input:disabled{opacity:.55; cursor:not-allowed}

    .container{
      background:var(--card-bg); border-radius:20px; padding:44px; border:1px solid var(--border-color);
      box-shadow:0 15px 40px rgba(0,0,0,.35); width:100%; max-width:980px; animation:fadeIn .45s ease
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)}}

    h1{
      font-weight:800; text-align:center; font-size:3.1em; margin:0 0 6px;
      background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent
    }
    .subtitle{text-align:center; margin-bottom:32px; opacity:.8; font-size:1.05em}

    .input-group{margin-bottom:26px}
    .seats-threshold-group{display:flex; align-items:center; gap:10px}
    .seats-threshold-group input[type="text"]{flex:1}

    input[type="text"], input[type="number"]{
      padding:14px; border:1px solid var(--border-color); border-radius:12px; background:var(--input-bg);
      color:var(--text-color); box-sizing:border-box; font-size:1.05em; transition:all .2s
    }
    input::placeholder{color:var(--text-color); opacity:.5}
    input:focus{outline:none; box-shadow:0 0 0 3px color-mix(in oklab, var(--secondary-color) 35%, transparent); border-color:var(--secondary-color)}

    .alliance-entry,.party-entry,.independent-entry{margin-bottom:16px; display:flex; align-items:center; gap:12px}
    .alliance-entry{
      flex-direction:column; align-items:stretch; padding:16px; border:2px dashed var(--border-color);
      border-radius:14px; background:rgba(255,255,255,.03)
    }
    .alliance-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:10px}
    .alliance-header input{flex:1; font-weight:700; font-size:1.05em}
    .alliance-parties-container{min-height:48px; display:flex; flex-direction:column; gap:10px}

    .party-name{flex:3}
    .party-votes{flex:1.5}
    .party-color-group{display:flex; gap:6px; align-items:center}
    .party-color-hex{width:110px; padding:12px; text-align:center}

    /* Renk Seçici Modifikasyonu */
    input[type="color"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 42px; /* Genişlik ayarla */
      height: 42px; /* Yükseklik ayarla */
      padding: 0;
      border: none;
      border-radius: 12px; /* Köşeleri yuvarla */
      cursor: pointer;
      background: var(--input-bg); /* Arkaplan rengi temaya uysun */
      border: 1px solid var(--border-color); /* Kenarlık ekle */
      transition: all 0.2s ease;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
      border-radius: 10px; /* İç çerçevenin köşelerini yuvarla */
    }

    input[type="color"]::-webkit-color-swatch {
      border: none; /* Varsayılan kenarlığı kaldır */
      border-radius: 10px; /* Renk örneğinin köşelerini yuvarla */
    }

    input[type="color"]::-moz-color-swatch-wrapper {
        padding: 0;
        border-radius: 10px;
    }
    input[type="color"]::-moz-color-swatch {
        border: none;
        border-radius: 10px;
    }

    input[type="color"]:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }


    .move-control{width:30px; height:48px; display:flex; flex-direction:column; justify-content:center; align-items:center; border:1px solid var(--border-color); border-radius:10px; background:var(--button-bg)}
    .move-control-up,.move-control-down{flex:1; display:flex; align-items:center; justify-content:center; cursor:pointer; width:100%; color:#fff; font-size:1.1em}
    .move-control-up{border-radius:10px 10px 0 0}
    .move-control-down{border-radius:0 0 10px 10px}
    .move-control-up img,.move-control-down img{width:18px; height:18px;}

    /* Kaldır butonu (tema renkleriyle) */
    .delete-btn{
      background:var(--primary-color); color:#fff; border:none; padding:10px 12px; border-radius:10px; width:42px; height:42px;
      display:flex; justify-content:center; align-items:center; cursor:pointer; transition:transform .15s, filter .2s, background .2s
    }
    .delete-btn:hover{transform:scale(1.05); filter:brightness(1.05)}

    .add-party-btn,.add-independent-btn,.add-alliance-btn{
      width:100%; background:var(--secondary-color); color:#fff; border:none; padding:14px; border-radius:12px;
      cursor:pointer; font-size:1.05em; font-weight:700; transition:transform .15s, filter .2s; margin-top:8px;
      display:inline-flex; align-items:center; gap:8px; justify-content:center;
    }
    .add-party-btn:hover,.add-independent-btn:hover,.add-alliance-btn:hover{transform:translateY(-2px); filter:brightness(1.05)}
    :root.light-mode .add-party-btn, :root.light-mode .add-independent-btn, :root.light-mode .add-alliance-btn {
      color: var(--light-mode-secondary-text);
    }
    
    .results{margin-top:30px; background:var(--result-bg); padding:24px; border-radius:14px; border:1px solid var(--border-color); box-shadow:10px 10px 22px rgba(0,0,0,.22)}
    .results h2{
      margin:0 0 14px; font-size:1.7em; text-align:center;
      background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent
    }
    .results ul{list-style:none; padding:0; margin:0}
    .results li{
      background:var(--input-bg); padding:16px; border-radius:12px; margin-bottom:12px; display:flex;
      justify-content:space-between; align-items:center; transition:transform .2s; border-left:5px solid
    }
    .party-info{display:flex; align-items:center; gap:12px}
    .party-initial{width:38px; height:38px; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:800; font-size:1.2em; text-transform:uppercase; border:2px solid var(--border-color); flex-shrink:0}
    .seat-count{font-weight:800; font-size:1.25em; color:var(--primary-color)}
    .total-votes{text-align:right; opacity:.7; font-size:.98em; margin-top:12px}

    .file-buttons{display:flex; justify-content:center; gap:10px; margin-top:18px}
    .file-buttons button{
      padding:12px 18px; border-radius:10px; background:var(--button-bg); color:var(--text-color); border:1px solid var(--border-color);
      font-size:.98em; cursor:pointer; transition:background-color .2s, transform .15s; display:inline-flex; align-items:center; gap:8px;
    }
    .file-buttons button:hover{background:var(--button-hover-bg); transform:translateY(-2px)}
    .file-buttons input{display:none}

    .github-button{
      position:fixed; bottom:20px; left:20px; padding:10px 14px; border-radius:10px; background:var(--button-bg);
      color:var(--text-color); border:1px solid var(--border-color); font-size:.98em; cursor:pointer;
      transition:background-color .2s, transform .15s, box-shadow .2s; text-decoration:none; display:flex; align-items:center; gap:8px;
      z-index:999
    }
    .github-button:hover{background:var(--button-hover-bg); transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,.2)}

    @media (max-width:768px){
      body{padding:10px}
      .top-bar{top:0; left:0; right:0; padding:10px 12px; background:var(--bg-color); box-shadow:0 2px 5px rgba(0,0,0,.25)}
      .container{padding:28px 18px; margin-top:74px}
      h1{font-size:2.2em}
      .subtitle{font-size:1em; margin-bottom:18px}
      .seats-threshold-group{flex-direction:column; align-items:stretch}
      .threshold-control{flex-direction:column; align-items:stretch; gap:8px}
      .threshold-button,.threshold-input{width:100%; text-align:center}
      .party-entry,.independent-entry,.alliance-entry{flex-direction:column; align-items:stretch; gap:10px}
      .party-color-group{flex-wrap:wrap}
      .party-color-hex{flex:1}
      .github-button{bottom:10px; left:10px; padding:8px 12px; font-size:.9em}
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-left">
      <button id="themeButton" class="top-btn btn-with-icon" title="Tema">
        <img src="icon/theme.svg" alt="" class="icon" data-icon-name="theme"><span>Tema</span>
      </button>
    </div>
    <div class="top-right">
      <button id="methodButton" class="top-btn btn-with-icon" title="Hesaplama yöntemini değiştir">
        <img src="icon/settings.svg" alt="" class="icon" data-icon-name="settings"><span id="methodButtonText">D'Hondt</span>
      </button>
    </div>
  </div>

  <div class="container">
    <h1>Koltuk Hesaplayıcı</h1>
    <p class="subtitle" id="methodSubtitle">D'Hondt Yöntemi</p>

    <div class="input-group">
      <div class="seats-threshold-group">
        <input type="text" id="totalSeats" placeholder="Koltuk Sayısı" value="">
        <div class="threshold-control">
          <button id="thresholdButton" class="threshold-button btn-with-icon">
            <img src="icon/token.svg" alt="" class="icon" data-icon-name="token"><span id="thresholdLabel">Baraj: Kapalı</span>
          </button>
          <input type="text" id="thresholdInput" class="threshold-input" placeholder="%" min="0" max="100" value="" disabled>
        </div>
      </div>
    </div>

    <div id="main-container"></div>

    <div class="action-buttons" style="display:flex; gap:10px; margin-top:10px;">
      <button id="addPartyBtn" class="add-party-btn">
        <img src="icon/add.svg" alt="" class="icon" data-icon-name="add"><span>Parti Ekle</span>
      </button>
      <button id="addIndBtn" class="add-independent-btn">
        <img src="icon/add.svg" alt="" class="icon" data-icon-name="add"><span>Bağımsız Ekle</span>
      </button>
      <button id="addAllBtn" class="add-alliance-btn">
        <img src="icon/add.svg" alt="" class="icon" data-icon-name="add"><span>İttifak Ekle</span>
      </button>
    </div>

    <div id="output" class="results"></div>

    <div class="file-buttons">
      <button id="dlBtn" class="btn-with-icon"><img src="icon/download.svg" alt="" class="icon" data-icon-name="download"><span>Sonuçları Kaydet</span></button>
      <button id="ulBtn" class="btn-with-icon"><img src="icon/upload.svg" alt="" class="icon" data-icon-name="upload"><span>Dosyadan Yükle</span></button>
      <input type="file" id="fileInput" accept=".txt">
    </div>
  </div>

  <a href="https://github.com/TriQue06/koltuk-hesap" target="_blank" class="github-button btn-with-icon" rel="noopener">
    <img src="icon/github.svg" alt="GitHub" class="icon" data-icon-name="github">
    GitHub
  </a>

  <script>
    /* ===== Tema Etiketleri ===== */
    const THEME_LABELS = {
      light:'Açık', dark:'Koyu', retro:'Retro', vaporwave:'Vaporwave', forest:'Orman',
      ocean:'Okyanus', crimson:'Kızıl', sunset:'Gün Batımı', bal:'Bal'
    };

    /* ===== Temalar ===== */
    const THEMES = [
      {key:"light", tone:"light", vars:{
        bg:"#f7f7fb", card:"rgba(255,255,255,.92)", pri:"#4e54c8", sec:"#8f94fb", text:"#1a1a1a",
        border:"rgba(0,0,0,.12)", input:"rgba(0,0,0,.06)", result:"rgba(0,0,0,.03)", btn:"#e6e7ef", btnH:"#d8d9e6"
      }},
      {key:"dark", tone:"dark", vars:{
        bg:"#0f1118", card:"rgba(20,22,32,.92)", pri:"#7d5fff", sec:"#15aabf", text:"#eef1ff",
        border:"rgba(255,255,255,.16)", input:"rgba(255,255,255,.07)", result:"rgba(255,255,255,.05)", btn:"#2a2e3f", btnH:"#343955"
      }},
      {key:"retro", tone:"dark", vars:{
        bg:"#1a2430", card:"rgba(24,36,48,.92)", pri:"#f39c12", sec:"#e74c3c", text:"#fef9e7",
        border:"rgba(255,200,150,.2)", input:"rgba(255,200,150,.12)", result:"rgba(255,200,150,.08)", btn:"#3c3d47", btnH:"#4a4b58"
      }},
      {key:"vaporwave", tone:"dark", vars:{
        bg:"#2e1b3f", card:"rgba(40,20,65,.92)", pri:"#ff77e9", sec:"#00bbf9", text:"#fff0ff",
        border:"rgba(255,150,255,.22)", input:"rgba(255,150,255,.10)", result:"rgba(255,150,255,.08)", btn:"#4a275f", btnH:"#5c2f76"
      }},
      {key:"forest", tone:"dark", vars:{
        bg:"#0f1a14", card:"rgba(20,34,26,.9)", pri:"#2ecc71", sec:"#1abc9c", text:"#e9fff2",
        border:"rgba(200,255,230,.18)", input:"rgba(200,255,230,.08)", result:"rgba(200,255,230,.06)", btn:"#1f3a2d", btnH:"#29513f"
      }},
      {key:"ocean", tone:"dark", vars:{
        bg:"#0e1b2b", card:"rgba(16,34,54,.9)", pri:"#00b4d8", sec:"#48cae4", text:"#eaf6ff",
        border:"rgba(200,230,255,.18)", input:"rgba(200,230,255,.08)", result:"rgba(200,230,255,.06)", btn:"#163249", btnH:"#1f435f"
      }},
      {key:"crimson", tone:"dark", vars:{
        bg:"#2b0f14", card:"rgba(44,16,22,.92)", pri:"#ff4d6d", sec:"#ff8fab", text:"#fff0f3",
        border:"rgba(255,160,180,.22)", input:"rgba(255,160,180,.10)", result:"rgba(255,160,180,.08)", btn:"#4a1f28", btnH:"#5c2833"
      }},
      {key:"sunset", tone:"dark", vars:{
        bg:"#1b1220", card:"rgba(36,20,44,.9)", pri:"#ff7e5f", sec:"#feb47b", text:"#fff3ef",
        border:"rgba(255,200,180,.2)", input:"rgba(255,180,150,.1)", result:"rgba(255,160,130,.08)", btn:"#5c2b3a", btnH:"#6c3444"
      }},
      {key:"bal", tone:"dark", vars:{
        bg:"#361408", card:"rgba(54,20,8,.92)", pri:"#ff7b00", sec:"#f5b700", text:"#fff",
        border:"rgba(255,255,255,.18)", input:"rgba(255,255,255,.08)", result:"rgba(255,255,255,.05)", btn:"#6a3d16", btnH:"#8f531d"
      }}
    ];
    
    let themeIndex = 0;
    const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)');
    
    function setCSSVars(vars){
      const r=document.documentElement.style;
      r.setProperty('--bg-color', vars.bg);
      r.setProperty('--card-bg', vars.card);
      r.setProperty('--primary-color', vars.pri);
      r.setProperty('--secondary-color', vars.sec);
      r.setProperty('--text-color', vars.text);
      r.setProperty('--border-color', vars.border);
      r.setProperty('--input-bg', vars.input);
      r.setProperty('--result-bg', vars.result);
      r.setProperty('--button-bg', vars.btn);
      r.setProperty('--button-hover-bg', vars.btnH);
    }

    function updateIcons(isLightMode) {
      const iconPath = `icon/`;
      const themeSuffix = isLightMode ? '-light.svg' : '.svg';
      document.querySelectorAll('.icon').forEach(icon => {
        const iconName = icon.dataset.iconName;
        if (iconName) {
          icon.src = `${iconPath}${iconName}${themeSuffix}`;
        }
      });
    }

    function applyThemeByIndex(idx){
      const t = THEMES[(idx+THEMES.length)%THEMES.length];
      const isLightMode = t.tone === 'light';
      setCSSVars(t.vars);
      document.documentElement.classList.toggle('light-mode', isLightMode);
      updateIcons(isLightMode);
      document.getElementById('themeButton').querySelector('span').textContent = THEME_LABELS[t.key] || t.key;
      calculate();
      renderThresholdButton();
    }
    
    /* ===== Metodlar ===== */
    const METHODS = ["D'Hondt","Sainte-Laguë","Hare Kotası"];
    let currentMethodIndex = 0;

    /* ===== Baraj ===== */
    let isThresholdEnabled = false;
    let storedThresholdValue = '';

    /* ===== Yardımcılar ===== */
    const $ = sel => document.querySelector(sel);
    function getContrastColor(hex){
      const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
      const L=(0.299*r+0.587*g+0.114*b)/255; return L>0.5?'black':'white';
    }
    function parseVoteValue(v){ if(typeof v==='string'){ v=v.replace(/[\.,]/g,'') } return parseInt(v) }
    function parseThresholdValue(v){ if(typeof v==='string'){ v=v.replace(',','.') } return parseFloat(v) }
    function generateRandomColor(){ const letters='0123456789ABCDEF'; let c='#'; for(let i=0;i<6;i++){ c+=letters[Math.floor(Math.random()*16)] } return c }

    function moveElement(element,direction){
      const mainContainer = $('#main-container');
      const parent = element.parentNode;
      const isElementInAlliance = parent.classList.contains('alliance-parties-container');

      if(direction==='up'){
        const siblings = Array.from(parent.children).filter(el=>el.nodeType===1);
        const index = siblings.indexOf(element);
        if(isElementInAlliance){
          if(index>0){ parent.insertBefore(element, siblings[index-1]) }
          else{
            const alliance = parent.closest('.alliance-entry');
            mainContainer.insertBefore(element, alliance);
            element.dataset.allianceId = 'null';
          }
        }else{
          const siblingsInMain = Array.from(mainContainer.children).filter(el=>el.nodeType===1);
          const indexInMain = siblingsInMain.indexOf(element);
          if(indexInMain>0){
            const prevSibling = siblingsInMain[indexInMain-1];
            if(element.dataset.type==='party' && prevSibling.dataset.type==='alliance'){
              prevSibling.querySelector('.alliance-parties-container').appendChild(element);
              element.dataset.allianceId = prevSibling.dataset.allianceId;
            }else{
              mainContainer.insertBefore(element, prevSibling);
            }
          }
        }
      }else{
        const siblings = Array.from(parent.children).filter(el=>el.nodeType===1);
        const index = siblings.indexOf(element);
        const mainChildren = Array.from($('#main-container').children).filter(el=>el.nodeType===1);

        if(isElementInAlliance){
          if(index < siblings.length-1){ parent.insertBefore(element, siblings[index+1].nextSibling) }
          else{
            const alliance = parent.closest('.alliance-entry');
            const indexInMain = mainChildren.indexOf(alliance);
            if(indexInMain < mainChildren.length-1){
              mainContainer.insertBefore(element, mainChildren[indexInMain+1]);
              element.dataset.allianceId = 'null';
            }else{
              mainContainer.appendChild(element);
              element.dataset.allianceId = 'null';
            }
          }
        }else{
          const indexInMain = mainChildren.indexOf(element);
          if(indexInMain < mainChildren.length-1){
            const nextSibling = mainChildren[indexInMain+1];
            if(element.dataset.type==='party' && nextSibling.dataset.type==='alliance'){
              nextSibling.querySelector('.alliance-parties-container').appendChild(element);
              element.dataset.allianceId = nextSibling.dataset.allianceId;
            }else{
              mainContainer.insertBefore(element, nextSibling.nextSibling);
            }
          }
        }
      }
      calculate();
    }

    function addIndependent(name='',votes='',color=generateRandomColor()){
      const div=document.createElement('div');
      div.className='independent-entry'; div.dataset.type='independent';
      div.innerHTML=`
        <div class="move-control">
          <div class="move-control-up"><img src="icon/up.svg" alt="Yukarı" class="icon" data-icon-name="up"></div>
          <div class="move-control-down"><img src="icon/down.svg" alt="Aşağı" class="icon" data-icon-name="down"></div>
        </div>
        <input type="text" placeholder="Bağımsız Aday Adı" value="${name}" class="party-name">
        <input type="text" placeholder="Oy Sayısı" value="${votes}" class="party-votes">
        <div class="party-color-group">
          <input type="color" class="party-color-picker" value="${color}">
          <input type="text" class="party-color-hex" value="${color}" placeholder="#RRGGBB" maxlength="7">
        </div>
        <button type="button" class="delete-btn" title="Kaldır">
          <img src="icon/remove.svg" alt="" class="icon" data-icon-name="remove">
        </button>
      `;
      div.querySelectorAll('input').forEach(i=>i.addEventListener('input',calculate));
      div.querySelector('.delete-btn').addEventListener('click',()=>{ div.remove(); calculate(); });
      div.querySelector('.move-control-up').addEventListener('click',()=>moveElement(div,'up'));
      div.querySelector('.move-control-down').addEventListener('click',()=>moveElement(div,'down'));

      const picker=div.querySelector('.party-color-picker'), hex=div.querySelector('.party-color-hex');
      picker.addEventListener('input',()=>{ hex.value=picker.value; calculate() });
      hex.addEventListener('input',()=>{
        let val=hex.value.trim(); if(!val.startsWith('#')) val='#'+val;
        if(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(val)){ picker.value=val; calculate() }
      });

      $('#main-container').appendChild(div);
      applyThemeByIndex(themeIndex); // Yeni eklenen ikonlar için tema güncellemesi
      calculate();
    }

    function addParty(name='',votes='',color=generateRandomColor(),parentId=null){
      if(parentId==='null' || !parentId) parentId=null;
      const div=document.createElement('div');
      div.className='party-entry'; div.dataset.allianceId=parentId; div.dataset.type='party';
      div.innerHTML=`
        <div class="move-control">
          <div class="move-control-up"><img src="icon/up.svg" alt="Yukarı" class="icon" data-icon-name="up"></div>
          <div class="move-control-down"><img src="icon/down.svg" alt="Aşağı" class="icon" data-icon-name="down"></div>
        </div>
        <input type="text" placeholder="Parti Adı" value="${name}" class="party-name">
        <input type="text" placeholder="Oy Sayısı" value="${votes}" class="party-votes">
        <div class="party-color-group">
          <input type="color" class="party-color-picker" value="${color}">
          <input type="text" class="party-color-hex" value="${color}" placeholder="#RRGGBB" maxlength="7">
        </div>
        <button type="button" class="delete-btn" title="Kaldır">
          <img src="icon/remove.svg" alt="" class="icon" data-icon-name="remove">
        </button>
      `;
      div.querySelectorAll('input').forEach(i=>i.addEventListener('input',calculate));
      div.querySelector('.delete-btn').addEventListener('click',()=>{ div.remove(); calculate(); });
      div.querySelector('.move-control-up').addEventListener('click',()=>moveElement(div,'up'));
      div.querySelector('.move-control-down').addEventListener('click',()=>moveElement(div,'down'));

      const picker=div.querySelector('.party-color-picker'), hex=div.querySelector('.party-color-hex');
      picker.addEventListener('input',()=>{ hex.value=picker.value; calculate() });
      hex.addEventListener('input',()=>{
        let val=hex.value.trim(); if(!val.startsWith('#')) val='#'+val;
        if(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(val)){ picker.value=val; calculate() }
      });

      const parentContainer = parentId ? document.getElementById(parentId).querySelector('.alliance-parties-container')
                                       : $('#main-container');
      parentContainer.appendChild(div);
      applyThemeByIndex(themeIndex); // Yeni eklenen ikonlar için tema güncellemesi
      calculate();
    }

    function addAlliance(name='',id=null){
      if(!id) id=`alliance-${Date.now()}`;
      const div=document.createElement('div');
      div.className='alliance-entry'; div.dataset.allianceId=id; div.dataset.type='alliance'; div.id=id;
      div.innerHTML=`
        <div class="alliance-header">
          <div class="move-control">
            <div class="move-control-up"><img src="icon/up.svg" alt="Yukarı" class="icon" data-icon-name="up"></div>
            <div class="move-control-down"><img src="icon/down.svg" alt="Aşağı" class="icon" data-icon-name="down"></div>
          </div>
          <input type="text" class="alliance-name" placeholder="İttifak Adı" value="${name}">
          <button type="button" class="delete-btn" title="İttifakı Kaldır">
            <img src="icon/remove.svg" alt="" class="icon" data-icon-name="remove">
          </button>
        </div>
        <div class="alliance-parties-container"></div>
      `;
      div.querySelector('.alliance-name').addEventListener('input',calculate);
      div.querySelector('.delete-btn').addEventListener('click',()=>{ div.remove(); calculate(); });
      div.querySelector('.move-control-up').addEventListener('click',()=>moveElement(div,'up'));
      div.querySelector('.move-control-down').addEventListener('click',()=>moveElement(div,'down'));
      $('#main-container').appendChild(div);
      applyThemeByIndex(themeIndex); // Yeni eklenen ikonlar için tema güncellemesi
      calculate();
      return div;
    }

    function calculate(){
      document.getElementById('methodSubtitle').textContent = `${METHODS[currentMethodIndex]} Yöntemi`;

      const seats = parseInt($('#totalSeats').value);
      const totalVotes = Array.from(document.querySelectorAll('.party-entry .party-votes, .independent-entry .party-votes'))
        .reduce((sum,input)=>{ const v=parseVoteValue(input.value); return sum+(isNaN(v)?0:v) },0);

      if(isNaN(seats) || seats<=0 || totalVotes===0){ $('#output').innerHTML=""; return }

      const threshold = isThresholdEnabled ? parseThresholdValue($('#thresholdInput').value) : 0;
      const eligibleParties = [];
      const allCandidates = [];

      document.querySelectorAll('.party-entry').forEach(entry=>{
        const name=entry.querySelector('.party-name').value.trim();
        const votes=parseVoteValue(entry.querySelector('.party-votes').value);
        const color=entry.querySelector('.party-color-picker').value;
        const allianceId=entry.dataset.allianceId;
        if(name && !isNaN(votes) && votes>=0){ allCandidates.push({name,votes,color,seats:0,allianceId,type:'party'}) }
      });

      document.querySelectorAll('.independent-entry').forEach(entry=>{
        const name=entry.querySelector('.party-name').value.trim();
        const votes=parseVoteValue(entry.querySelector('.party-votes').value);
        const color=entry.querySelector('.party-color-picker').value;
        if(name && !isNaN(votes) && votes>=0){ allCandidates.push({name,votes,color,seats:0,type:'independent'}) }
      });

      const alliances={};
      document.querySelectorAll('.alliance-entry').forEach(allianceDiv=>{
        const id=allianceDiv.dataset.allianceId;
        const name=allianceDiv.querySelector('.alliance-name').value.trim();
        alliances[id]={name,votes:0,parties:[]};
      });

      allCandidates.forEach(p=>{
        if(p.type==='party' && p.allianceId!=='null' && alliances[p.allianceId]){
          alliances[p.allianceId].votes+=p.votes;
          alliances[p.allianceId].parties.push(p);
        }
      });

      allCandidates.forEach(p=>{
        if(p.type==='independent'){
          if((p.votes/totalVotes)*100 >= threshold){ eligibleParties.push(p) }
        }else{
          const alliance=alliances[p.allianceId];
          if(alliance){
            const aPerc=(alliance.votes/totalVotes)*100;
            if(aPerc>=threshold){ eligibleParties.push(p) }
          }else if(((p.votes/totalVotes)*100)>=threshold){ eligibleParties.push(p) }
        }
      });
      
      const totalEligibleVotes = eligibleParties.reduce((sum,p)=>sum+p.votes,0);

      let finalResults;
      if(METHODS[currentMethodIndex]==="Hare Kotası"){ finalResults=calculateHare(eligibleParties,seats,totalEligibleVotes) }
      else if(METHODS[currentMethodIndex]==="D'Hondt"){ finalResults=calculateDhondt(eligibleParties,seats) }
      else if(METHODS[currentMethodIndex]==="Sainte-Laguë"){ finalResults=calculateSainteLague(eligibleParties,seats) }

      let out='<h2>Sonuçlar</h2><ul>';
      const allResults = allCandidates.map(p=>finalResults.find(r=>r.name===p.name) ?? {...p,seats:0});
      const sorted = allResults.sort((a,b)=>b.votes-a.votes);

      for(const r of sorted){
        const percentage=((r.votes/totalVotes)*100).toFixed(2);
        const initial=r.name.charAt(0).toUpperCase();
        const initialColor=getContrastColor(r.color);
        out+=`<li style="border-left:5px solid ${r.color};">
                <div class="party-info">
                  <div class="party-initial" style="background-color:${r.color};color:${initialColor};">${initial}</div>
                  <span><strong>${r.name}</strong> (${percentage}%)</span>
                </div>
                <span class="seat-count">${r.seats} Koltuk</span>
              </li>`;
      }
      out+='</ul>';
      out+=`<div class="total-votes">Toplam Oy: ${totalVotes.toLocaleString()}</div>`;
      $('#output').innerHTML=out;
    }

    function calculateHare(parties,seats,totalEligibleVotes){
      if(totalEligibleVotes===0) return parties.map(p=>({...p,seats:0}));
      const quota=totalEligibleVotes/seats;
      let allocatedSeats=0;
      const results = parties.map(p=>{
        const raw=p.votes/quota;
        const whole=Math.floor(raw);
        allocatedSeats+=whole;
        return {...p,seats:whole,remainder:raw-whole};
      });
      let remaining=seats-allocatedSeats;
      if(remaining<0) remaining=0; // Negatif olmaması için kontrol
      results.sort((a,b)=>b.remainder-a.remainder);
      for(let i=0;i<remaining;i++){ if(results[i]) results[i].seats++ }
      return results;
    }
    function calculateDhondt(parties,seats){
      const results=parties.map(p=>({...p,seats:0}));
      for(let i=0;i<seats;i++){
        let maxQ=-1, win=-1;
        results.forEach((p,idx)=>{ const q=p.votes/(p.seats+1); if(q>maxQ){ maxQ=q; win=idx } });
        if(win!==-1) results[win].seats++;
      }
      return results;
    }
    function calculateSainteLague(parties,seats){
      const results=parties.map(p=>({...p,seats:0}));
      for(let i=0;i<seats;i++){
        let maxQ=-1, win=-1;
        results.forEach((p,idx)=>{ const q=p.votes/(2*p.seats+1); if(q>maxQ){ maxQ=q; win=idx } });
        if(win!==-1) results[win].seats++;
      }
      return results;
    }

    function downloadResults(){
      const totalSeats=$('#totalSeats').value;
      const thresholdStatus=isThresholdEnabled?'Açık':'Kapalı';
      const thresholdValue=isThresholdEnabled?$('#thresholdInput').value:'';
      const calculationMethod=METHODS[currentMethodIndex];
      const themeName = THEMES[themeIndex].key;

      let content=`Toplam Koltuk Sayısı: ${totalSeats}\n`;
      content+=`Baraj Durumu: ${thresholdStatus}${thresholdValue?`, ${thresholdValue}`:''}\n`;
      content+=`Hesaplama Yöntemi: ${calculationMethod}\n`;
      content+=`Tema: ${themeName}\n`;
      content+='---\n';

      document.querySelectorAll('#main-container > div').forEach(container=>{
        if(container.classList.contains('alliance-entry')){
          const allianceName=container.querySelector('.alliance-name').value.trim();
          const allianceId=container.dataset.allianceId;
          content+=`Alliance|${allianceName}|${allianceId}\n`;
          container.querySelectorAll('.party-entry').forEach(entry=>{
            const name=entry.querySelector('.party-name').value.trim();
            const votes=entry.querySelector('.party-votes').value;
            const color=entry.querySelector('.party-color-picker').value;
            if(name && votes){ content+=`  Party|${name}|${votes}|${color}|${allianceId}\n` }
          });
        }else if(container.classList.contains('party-entry')){
          const name=container.querySelector('.party-name').value.trim();
          const votes=container.querySelector('.party-votes').value;
          const color=container.querySelector('.party-color-picker').value;
          if(name && votes){ content+=`Party|${name}|${votes}|${color}\n` }
        }else if(container.classList.contains('independent-entry')){
          const name=container.querySelector('.party-name').value.trim();
          const votes=container.querySelector('.party-votes').value; // Corrected variable
          const color=container.querySelector('.party-color-picker').value;
          if(name && votes){ content+=`Independent|${name}|${votes}|${color}\n` }
        }
      });

      const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a'); link.href=url; link.download='koltuk-hesaplayici-sonuclar.txt'; link.click();
      URL.revokeObjectURL(url);
    }

    function uploadResults(event){
      const file=event.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=e=>{
        const lines=e.target.result.split('\n').filter(line=>line.trim()!=='');
        $('#main-container').innerHTML='';
        const alliances = {};

        if(lines.length>0 && lines[0].startsWith('Toplam Koltuk Sayısı:')){
          $('#totalSeats').value = lines.shift().split(':')[1].trim();
        }
        if(lines.length>0 && lines[0].startsWith('Baraj Durumu:')){
          const parts=lines.shift().split(':')[1].trim().split(',').map(p=>p.trim());
          const status=parts[0]; const value=parts[1]||'';
          isThresholdEnabled=(status==='Açık');
          if(isThresholdEnabled){
            document.getElementById('thresholdInput').disabled=false; document.getElementById('thresholdInput').value=value;
          }else{
            document.getElementById('thresholdInput').disabled=true; storedThresholdValue=value; document.getElementById('thresholdInput').value='';
          }
          renderThresholdButton();
        }
        if(lines.length>0 && lines[0].startsWith('Hesaplama Yöntemi:')){
          const methodName=lines.shift().split(':')[1].trim();
          const idx=METHODS.indexOf(methodName);
          if(idx!==-1){ currentMethodIndex=idx; document.getElementById('methodButtonText').textContent = METHODS[currentMethodIndex] }
        }
        if(lines.length>0 && lines[0].startsWith('Tema:')){
          const themeName = lines.shift().split(':')[1].trim();
          const idx = THEMES.findIndex(t=> t.key === themeName);
          if(idx>=0){ themeIndex=idx; applyThemeByIndex(themeIndex) }
        }
        if(lines.length>0 && lines[0]==='---'){ lines.shift() }

        lines.forEach(line=>{
          const parts=line.split('|').map(p=>p.trim());
          if(parts[0]==='Alliance' && parts.length>=3){
            const allianceName=parts[1]; const allianceId=parts[2];
            const allianceDiv = addAlliance(allianceName,allianceId);
            alliances[allianceId] = allianceDiv;
          } else if(parts[0]==='Party' && parts.length>=4){
            const name=parts[1]; const votes=parts[2]; const color=parts[3]||'#808080';
            const allianceId = parts.length > 4 ? parts[4] : null;
            addParty(name, votes, color, allianceId);
          } else if(parts[0]==='Independent' && parts.length>=4){
            const name=parts[1]; const votes=parts[2]; const color=parts[3]||'#808080';
            addIndependent(name,votes,color);
          }
        });

        calculate();
      };
      reader.readAsText(file);
    }

    /* Baraj butonu görünümünü (ikon + metin + sınıf) tek yerden yönet */
    function renderThresholdButton(){
      const btn = document.getElementById('thresholdButton');
      const label = document.getElementById('thresholdLabel');
      label.textContent = `Baraj: ${isThresholdEnabled ? 'Açık' : 'Kapalı'}`;
      btn.classList.toggle('active', isThresholdEnabled);
    }

    // ==== Olaylar & Başlangıç ====
    document.addEventListener('DOMContentLoaded', ()=>{
      // Tema
      document.getElementById('themeButton').addEventListener('click',()=>{
        themeIndex=(themeIndex+1)%THEMES.length;
        applyThemeByIndex(themeIndex);
      });
      applyThemeByIndex(themeIndex);

      // Metod butonu
      document.getElementById('methodButton').addEventListener('click', ()=>{
        currentMethodIndex = (currentMethodIndex + 1) % METHODS.length;
        document.getElementById('methodButtonText').textContent = METHODS[currentMethodIndex];
        calculate();
      });

      // Baraj
      document.getElementById('thresholdButton').addEventListener('click',()=>{
        isThresholdEnabled=!isThresholdEnabled;
        if(isThresholdEnabled){
          document.getElementById('thresholdInput').disabled=false;
          document.getElementById('thresholdInput').value=storedThresholdValue;
        }else{
          document.getElementById('thresholdInput').disabled=true;
          storedThresholdValue=document.getElementById('thresholdInput').value;
          document.getElementById('thresholdInput').value='';
        }
        renderThresholdButton();
        calculate();
      });

      // Form
      document.getElementById('totalSeats').addEventListener('input',calculate);
      document.getElementById('thresholdInput').addEventListener('input',calculate);

      // Ekleme butonları
      document.getElementById('addPartyBtn').addEventListener('click',()=>addParty());
      document.getElementById('addIndBtn').addEventListener('click',()=>addIndependent());
      document.getElementById('addAllBtn').addEventListener('click',()=>addAlliance());

      // Dosya işlemleri
      document.getElementById('dlBtn').addEventListener('click',downloadResults);
      document.getElementById('ulBtn').addEventListener('click',()=>document.getElementById('fileInput').click());
      document.getElementById('fileInput').addEventListener('change',uploadResults);

      // Başlangıçta baraj butonu görünümünü kur
      renderThresholdButton();
    });
  </script>
</body>
</html>