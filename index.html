<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>✨ Koltuk Hesaplayıcı ✨</title>
  <style>
    @font-face{font-family:'Product Sans';src:url('font/ProductSans-Regular.ttf') format('truetype');font-weight:400;font-style:normal}
    @font-face{font-family:'Product Sans';src:url('font/ProductSans-Medium.ttf')  format('truetype');font-weight:500;font-style:normal}
    @font-face{font-family:'Product Sans';src:url('font/ProductSans-Bold.ttf')    format('truetype');font-weight:700;font-style:normal}
    @font-face{font-family:'Product Sans';src:url('font/ProductSans-Light.ttf')   format('truetype');font-weight:300;font-style:normal}
    *{font-family:'Product Sans',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    button,input,select,textarea{font:inherit}

    :root{
      --bg-color:#0f1118; --card-bg:rgba(20,22,32,.92);
      --primary-color:#7d5fff; --secondary-color:#15aabf;
      --text-color:#eef1ff; --border-color:rgba(255,255,255,.16);
      --input-bg:rgba(255,255,255,.07); --result-bg:rgba(255,255,255,.05);
      --button-bg:#2a2e3f; --button-hover-bg:#343955;
      --light-mode-secondary-text:#000;
    }

    :root.light-mode{

    }

    body{
      background:var(--bg-color); color:var(--text-color);
      min-height:100vh; display:flex; justify-content:center; align-items:center;
      padding:20px; margin:0; position:relative; transition:background-color .25s,color .25s
    }

    .top-bar{
      position:fixed; top:20px; left:20px; right:20px; z-index:1000;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      pointer-events:none;
    }
    .top-left,.top-right{display:flex; align-items:center; gap:10px; pointer-events:auto}
    .top-btn{
      padding:10px 14px; border-radius:12px; background:var(--button-bg); color:var(--text-color);
      border:1px solid var(--border-color); font-size:1em; cursor:pointer; transition:background-color .25s, transform .15s;
      position:relative; z-index:1001; display:inline-flex; align-items:center; gap:8px;
    }
    .top-btn:hover{background:var(--button-hover-bg); transform:translateY(-1px)}
    .icon{
      width:20px; height:20px;
    }
    .btn-with-icon{display:inline-flex; align-items:center; gap:8px}

    .threshold-control{display:flex; align-items:center; gap:15px} /* gap 10px'ten 15px'e çıkarıldı */
    .threshold-input{width:80px; padding:12px; font-size:1em; box-sizing:border-box}
    .threshold-button{
      padding:12px 16px; border:1px solid var(--border-color); border-radius:12px; background:var(--input-bg);
      color:var(--text-color); font-weight:600; cursor:pointer; transition:background-color .25s,border-color .25s; font-size:1em;
      display:inline-flex; align-items:center; gap:8px; justify-content:center;
    }
    .threshold-button span{
      white-space: nowrap;
    }
    /* Baraj Butonu Genişliği Sabitlendi */
    #thresholdButton {
      width: 150px;
    }
    /* Bağımsız Aday Limiti Butonu Genişliği */
    #limitedIndependentButton{
      width: 200px;
    }
    .threshold-button.active{background:var(--primary-color); border-color:var(--primary-color); color:#fff}
    .threshold-input:disabled{opacity:.55; cursor:not-allowed}

    .container{
      background:var(--card-bg); border-radius:20px; padding:30px; border:1px solid var(--border-color);
      box-shadow:0 15px 40px rgba(0,0,0,.35); width:100%; max-width:650px;
      animation:fadeIn .45s ease
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)}}

    h1{
      font-weight:800; text-align:center; font-size:3em; margin:0 0 8px;
      background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent
    }
    .subtitle{text-align:center; margin-bottom:28px; opacity:.8; font-size:1.1em}

    .input-group{margin-bottom:20px}
    .seats-threshold-group{display:flex; align-items:center; gap:15px}

    /* Koltuk Sayısı girişinin genişliği %50 artırılarak 173px'e sabitlendi */
    #totalSeats {
      width: 173px;
      padding:12px; font-size:1.05em;
      box-sizing: border-box;
    }

    input[type="text"], input[type="number"]{
      padding:12px; border:1px solid var(--border-color); border-radius:12px; background:var(--input-bg);
      color:var(--text-color); box-sizing:border-box; font-size:1.05em; transition:all .2s
    }
    input::placeholder{color:var(--text-color); opacity:.5}
    input:focus{outline:none; box-shadow:0 0 0 3px color-mix(in oklab, var(--secondary-color) 35%, transparent); border-color:var(--secondary-color)}

    .alliance-entry,.party-entry,.independent-entry{margin-bottom:14px; display:flex; align-items:center; gap:12px}
    .alliance-entry{
      flex-direction:column; align-items:stretch; padding:18px; border:2px dashed var(--border-color);
      border-radius:15px; background:rgba(255,255,255,.03)
    }
    .alliance-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:12px}
    .alliance-header input{flex:1; font-weight:600; font-size:1.1em}
    .alliance-parties-container{min-height:30px; display:flex; flex-direction:column; gap:10px}

    .party-name{flex:2} /* Genişlik 3'ten 2'ye düşürüldü */
    .party-votes{flex:1.5} /* Genişlik korunuyor */

    .move-control{width:44px; height:44px; display:flex; flex-direction:column; justify-content:center; align-items:center; border:1px solid var(--border-color); border-radius:12px; background:var(--button-bg)}
    .move-control-up,.move-control-down{flex:1; display:flex; align-items:center; justify-content:center; cursor:pointer; width:100%; color:#fff; font-size:1.1em}
    .move-control-up{border-radius:10px 10px 0 0}
    .move-control-down{border-radius:0 0 10px 10px}
    .move-control-up img,.move-control-down img{width:18px; height:18px;}

    .delete-btn{
      background:var(--primary-color); color:#fff; border:none; padding:10px; border-radius:12px; width:44px; height:44px;
      display:flex; justify-content:center; align-items:center; cursor:pointer; transition:transform .15s, filter .2s, background .2s
    }
    .delete-btn:hover{transform:scale(1.05); filter:brightness(1.05)}

    .add-party-btn,.add-independent-btn,.add-alliance-btn{
      width:100%; background:var(--secondary-color); color:#fff; border:none; padding:12px; border-radius:12px;
      cursor:pointer; font-size:1.1em; font-weight:600; transition:transform .15s, filter .2s; margin-top:12px;
      display:inline-flex; align-items:center; gap:10px; justify-content:center;
    }
    .add-party-btn:hover,.add-independent-btn:hover,.add-alliance-btn:hover{transform:translateY(-1px); filter:brightness(1.05)}
    :root.light-mode .add-party-btn, :root.light-mode .add-independent-btn, :root.light-mode .add-alliance-btn {
      color: var(--light-mode-secondary-text);
    }

    .results{margin-top:28px; background:var(--result-bg); padding:25px; border-radius:15px; border:1px solid var(--border-color); box-shadow:10px 10px 22px rgba(0,0,0,.22)}
    .results h2{
      margin:0 0 14px; font-size:1.8em; text-align:center;
      background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent
    }
    .results ul{list-style:none; padding:0; margin:0}
    .results li{
      background:var(--input-bg); padding:16px; border-radius:12px; margin-bottom:12px; display:flex;
      justify-content:space-between; align-items:center; transition:transform .2s; border-left:5px solid var(--primary-color);
    }
    .party-info{display:flex; align-items:center; gap:12px}
    .seat-count{font-weight:700; font-size:1.4em; color:var(--primary-color)}
    .total-votes{text-align:right; opacity:.7; font-size:1em; margin-top:15px}

    .file-buttons{display:flex; justify-content:center; gap:15px; margin-top:20px}
    .file-buttons button{
      padding:12px 18px; border-radius:12px; background:var(--button-bg); color:var(--text-color); border:1px solid var(--border-color);
      font-size:1em; cursor:pointer; transition:background-color .2s, transform .15s; display:inline-flex; align-items:center; gap:10px;
    }
    .file-buttons button:hover{background:var(--button-hover-bg); transform:translateY(-1px)}
    .file-buttons input{display:none}

    .github-button{
      position:fixed; bottom:20px; left:20px; padding:10px 14px; border-radius:10px; background:var(--button-bg);
      color:var(--text-color); border:1px solid var(--border-color); font-size:1em; cursor:pointer;
      transition:background-color .2s, transform .15s, box-shadow .2s; text-decoration:none; display:flex; align-items:center; gap:8px;
      z-index:999
    }
    .github-button:hover{background:var(--button-hover-bg); transform:translateY(-1px); box-shadow:0 2px 8px rgba(0,0,0,.2)}

    .fixed-bottom-right{
      position:fixed;
      bottom:20px;
      right:20px;
      padding:10px 14px;
      border-radius:10px;
      background:var(--secondary-color);
      color:var(--text-color);
      border:1px solid var(--border-color);
      font-size:1em;
      font-weight:600;
      cursor:pointer;
      transition:background-color .2s, transform .15s, box-shadow .2s;
      text-decoration:none;
      z-index:999;
    }
    .fixed-bottom-right:hover{
      background:color-mix(in srgb, var(--secondary-color), black 10%);
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
  </style>
</head>
<body>
<div class="top-bar">
  <div class="top-left">
    <button id="themeButton" class="top-btn btn-with-icon" title="Tema">
      <img src="icon/theme.svg" alt="" class="icon" data-icon-name="theme"><span>Sistem Varsayılanı</span>
    </button>
  </div>
  <div class="top-right">
    <button id="methodButton" class="top-btn btn-with-icon" title="Hesaplama yöntemini değiştir">
      <img src="icon/settings.svg" alt="" class="icon" data-icon-name="settings"><span id="methodButtonText">D'Hondt</span>
    </button>
  </div>
</div>

<div class="container">
  <h1>Koltuk Hesaplayıcı</h1>
  <p class="subtitle" id="methodSubtitle">D'Hondt Yöntemi</p>

  <div class="input-group">
    <div class="seats-threshold-group">
      <input type="text" id="totalSeats" placeholder="Koltuk Sayısı" value="">
      <div class="threshold-control">
        <button id="limitedIndependentButton" class="threshold-button btn-with-icon">
          <img src="icon/token.svg" alt="" class="icon" data-icon-name="token"><span id="limitedIndependentLabel">Bağımsız Limit: Kapalı</span>
        </button>
        <button id="thresholdButton" class="threshold-button btn-with-icon">
          <img src="icon/token.svg" alt="" class="icon" data-icon-name="token"><span id="thresholdLabel">Baraj: Kapalı</span>
        </button>
        <input type="text" id="thresholdInput" class="threshold-input" placeholder="%" min="0" max="100" value="" disabled>
      </div>
    </div>
  </div>

  <div id="main-container"></div>

  <div class="action-buttons" style="display:flex; gap:15px; margin-top:15px;">
    <button id="addPartyBtn" class="add-party-btn">
      <img src="icon/add.svg" alt="" class="icon" data-icon-name="add"><span>Parti Ekle</span>
    </button>
    <button id="addIndBtn" class="add-independent-btn">
      <img src="icon/add.svg" alt="" class="icon" data-icon-name="add"><span>Bağımsız Ekle</span>
    </button>
    <button id="addAllBtn" class="add-alliance-btn">
      <img src="icon/add.svg" alt="" class="icon" data-icon-name="add"><span>İttifak Ekle</span>
    </button>
  </div>

  <div id="output" class="results"></div>

  <div class="file-buttons">
    <button id="dlBtn" class="btn-with-icon"><img src="icon/download.svg" alt="" class="icon" data-icon-name="download"><span>Sonuçları Kaydet</span></button>
    <button id="ulBtn" class="btn-with-icon"><img src="icon/upload.svg" alt="" class="icon" data-icon-name="upload"><span>Dosyadan Yükle</span></button>
    <input type="file" id="fileInput" accept=".txt">
  </div>
</div>

<a href="yuzdelik.html" target="_self" class="fixed-bottom-right" title="Yüzdelik Hesaplayıcı">
  Yüzdelik Hesaplayıcı
</a>

<a href="https://github.com/TriQue06/koltuk-hesap" target="_blank" class="github-button btn-with-icon" rel="noopener">
  <img src="icon/github.svg" alt="GitHub" class="icon" data-icon-name="github">
  GitHub
</a>

<script>
  const THEME_LABELS = {
    system:'Sistem Varsayılanı', light:'Açık', dark:'Koyu',
    murdum:'Mürdüm', gece:'Gece (Mavi)', dawn:'Şafak (Mor)',
  };

  const THEMES = [
    {key:"system", tone:"system", vars:{}},
    {key:"light", tone:"light", vars:{
      bg:"#f7f7fb", card:"rgba(255,255,255,.92)", pri:"#4e54c8", sec:"#8f94fb", text:"#1a1a1a",
      border:"rgba(0,0,0,.12)", input:"rgba(0,0,0,.06)", result:"rgba(0,0,0,.03)", btn:"#e6e7ef", btnH:"#d8d9e6"
    }},
    {key:"dark", tone:"dark", vars:{
      bg:"#0f1118", card:"rgba(20,22,32,.92)", pri:"#7d5fff", sec:"#15aabf", text:"#eef1ff",
      border:"rgba(255,255,255,.16)", input:"rgba(255,255,255,.07)", result:"rgba(255,255,255,.05)", btn:"#2a2e3f", btnH:"#343955"
    }},
    {key:"murdum", tone:"dark", vars:{
      bg:"#1B0616", card:"rgba(35,15,40,.92)", pri:"#E91E63", sec:"#9C27B0", text:"#FAE3FF",
      border:"rgba(255,255,255,.12)", input:"rgba(255,255,255,.06)", result:"rgba(255,255,255,.04)", btn:"#FF9800", btnH:"#FFB300"
    }},
    {key:"gece", tone:"dark", vars:{
      bg:"#050B14", card:"rgba(15,25,40,.92)", pri:"#4ADEDE", sec:"#00BFFF", text:"#E0F7FA",
      border:"rgba(255,255,255,.15)", input:"rgba(255,255,255,.08)", result:"rgba(255,255,255,.05)", btn:"#203348", btnH:"#2A4461"
    }},
    {key:"dawn", tone:"dark", vars:{
      bg:"#140a1c", card:"rgba(25,15,35,.92)", pri:"#8c1bab", sec:"#e0529d", text:"#fae6ff",
      border:"rgba(255,255,255,.14)", input:"rgba(255,255,255,.06)", result:"rgba(255,255,255,.04)", btn:"#332047", btnH:"#4a3068"
    }},
  ];

  let themeIndex = 0;
  const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)');

  function getSystemThemeColors(){
    const isDark = prefersDark?.matches;
    const key = isDark ? 'dark' : 'light';
    const systemTheme = THEMES.find(t => t.key === key);
    return systemTheme ? systemTheme.vars : THEMES.find(t => t.key === 'dark').vars;
  }

  function setCSSVars(vars){
    const r=document.documentElement.style;
    r.setProperty('--bg-color', vars.bg);
    r.setProperty('--card-bg', vars.card);
    r.setProperty('--primary-color', vars.pri);
    r.setProperty('--secondary-color', vars.sec);
    r.setProperty('--text-color', vars.text);
    r.setProperty('--border-color', vars.border);
    r.setProperty('--input-bg', vars.input);
    r.setProperty('--result-bg', vars.result);
    r.setProperty('--button-bg', vars.btn);
    r.setProperty('--button-hover-bg', vars.btnH);
  }

  function updateIcons(isLightMode) {
    const iconPath = `icon/`;
    const themeSuffix = isLightMode ? '-light.svg' : '.svg';
    document.querySelectorAll('.icon').forEach(icon => {
      const iconName = icon.dataset.iconName;
      if (iconName) {
        if (iconName === 'token') {
          return;
        }
        icon.src = `${iconPath}${iconName}${themeSuffix}`;
      }
    });
    renderThresholdButton();
    renderLimitedIndependentButton();
  }

  function applyThemeByIndex(idx){
    const t = THEMES[(idx+THEMES.length)%THEMES.length];
    let finalVars = t.vars;
    let currentTone = t.tone;

    if (t.key === 'system') {
      finalVars = getSystemThemeColors();
      const isSystemDark = prefersDark?.matches;
      currentTone = isSystemDark ? 'dark' : 'light';
    }

    setCSSVars(finalVars);

    const isLightMode = currentTone === 'light';
    document.documentElement.classList.toggle('light-mode', isLightMode);

    updateIcons(isLightMode);
    document.getElementById('themeButton').querySelector('span').textContent = THEME_LABELS[t.key] || t.key;
    calculate();
  }

  const METHODS = ["D'Hondt","Sainte-Laguë","Hare Kotası"];
  let currentMethodIndex = 0;

  let isThresholdEnabled = false;
  let storedThresholdValue = '';

  let isLimitedIndependentEnabled = false;

  const $ = sel => document.querySelector(sel);
  function parseVoteValue(v){ if(typeof v==='string'){ v=v.replace(/[\.,]/g,'') } return parseInt(v) }
  function parseThresholdValue(v){ if(typeof v==='string'){ v=v.replace(',','.').replace('%','') } return parseFloat(v) }

  function moveElement(element,direction){
    const mainContainer = $('#main-container');
    const parent = element.parentNode;
    const isElementInAlliance = parent.classList.contains('alliance-parties-container');

    if(direction==='up'){
      const siblings = Array.from(parent.children).filter(el=>el.nodeType===1);
      const index = siblings.indexOf(element);
      if(isElementInAlliance){
        if(index>0){ parent.insertBefore(element, siblings[index-1]) }
        else{
          const alliance = parent.closest('.alliance-entry');
          mainContainer.insertBefore(element, alliance);
          element.dataset.allianceId = 'null';
        }
      }else{
        const siblingsInMain = Array.from(mainContainer.children).filter(el=>el.nodeType===1);
        const indexInMain = siblingsInMain.indexOf(element);
        if(indexInMain>0){
          const prevSibling = siblingsInMain[indexInMain-1];
          if(element.dataset.type==='party' && prevSibling.dataset.type==='alliance'){
            prevSibling.querySelector('.alliance-parties-container').appendChild(element);
            element.dataset.allianceId = prevSibling.dataset.allianceId;
          }else{
            mainContainer.insertBefore(element, prevSibling);
          }
        }
      }
    }else{
      const siblings = Array.from(parent.children).filter(el=>el.nodeType===1);
      const index = siblings.indexOf(element);
      const mainChildren = Array.from($('#main-container').children).filter(el=>el.nodeType===1);

      if(isElementInAlliance){
        if(index < siblings.length-1){ parent.insertBefore(element, siblings[index+1].nextSibling) }
        else{
          const alliance = parent.closest('.alliance-entry');
          const indexInMain = mainChildren.indexOf(alliance);
          if(indexInMain < mainChildren.length-1){
            mainContainer.insertBefore(element, mainChildren[indexInMain+1]);
            element.dataset.allianceId = 'null';
          }else{
            mainContainer.appendChild(element);
            element.dataset.allianceId = 'null';
          }
        }
      }else{
        const indexInMain = mainChildren.indexOf(element);
        if(indexInMain < mainChildren.length-1){
          const nextSibling = mainChildren[indexInMain+1];
          if(element.dataset.type==='party' && nextSibling.dataset.type==='alliance'){
            nextSibling.querySelector('.alliance-parties-container').appendChild(element);
            element.dataset.allianceId = nextSibling.dataset.allianceId;
          }else{
            mainContainer.insertBefore(element, nextSibling.nextSibling);
          }
        }
      }
    }
    calculate();
  }

  function addIndependent(name='',votes=''){
    const div=document.createElement('div');
    div.className='independent-entry'; div.dataset.type='independent';
    div.innerHTML=`
      <div class="move-control">
        <div class="move-control-up"><img src="icon/up.svg" alt="Yukarı" class="icon" data-icon-name="up"></div>
        <div class="move-control-down"><img src="icon/down.svg" alt="Aşağı" class="icon" data-icon-name="down"></div>
      </div>
      <input type="text" placeholder="Bağımsız Aday Adı" value="${name}" class="party-name">
      <input type="text" placeholder="Oy Sayısı" value="${votes}" class="party-votes">
      <button type="button" class="delete-btn" title="Kaldır">
        <img src="icon/remove.svg" alt="" class="icon" data-icon-name="remove">
      </button>
    `;
    div.querySelectorAll('input').forEach(i=>i.addEventListener('input',calculate));
    div.querySelector('.delete-btn').addEventListener('click',()=>{ div.remove(); calculate(); });
    div.querySelector('.move-control-up').addEventListener('click',()=>moveElement(div,'up'));
    div.querySelector('.move-control-down').addEventListener('click',()=>moveElement(div,'down'));

    $('#main-container').appendChild(div);
    applyThemeByIndex(themeIndex);
    calculate();
  }

  function addParty(name='',votes='',parentId=null){
    if(parentId==='null' || !parentId) parentId=null;
    const div=document.createElement('div');
    div.className='party-entry'; div.dataset.allianceId=parentId; div.dataset.type='party';
    div.innerHTML=`
      <div class="move-control">
        <div class="move-control-up"><img src="icon/up.svg" alt="Yukarı" class="icon" data-icon-name="up"></div>
        <div class="move-control-down"><img src="icon/down.svg" alt="Aşağı" class="icon" data-icon-name="down"></div>
      </div>
      <input type="text" placeholder="Parti Adı" value="${name}" class="party-name">
      <input type="text" placeholder="Oy Sayısı" value="${votes}" class="party-votes">
      <button type="button" class="delete-btn" title="Kaldır">
        <img src="icon/remove.svg" alt="" class="icon" data-icon-name="remove">
      </button>
    `;
    div.querySelectorAll('input').forEach(i=>i.addEventListener('input',calculate));
    div.querySelector('.delete-btn').addEventListener('click',()=>{ div.remove(); calculate(); });
    div.querySelector('.move-control-up').addEventListener('click',()=>moveElement(div,'up'));
    div.querySelector('.move-control-down').addEventListener('click',()=>moveElement(div,'down'));

    const parentContainer = parentId ? document.getElementById(parentId).querySelector('.alliance-parties-container')
                                     : $('#main-container');
    parentContainer.appendChild(div);
    applyThemeByIndex(themeIndex);
    calculate();
  }

  function addAlliance(name='',id=null){
    if(!id) id=`alliance-${Date.now()}`;
    const div=document.createElement('div');
    div.className='alliance-entry'; div.dataset.allianceId=id; div.dataset.type='alliance'; div.id=id;
    div.innerHTML=`
      <div class="alliance-header">
        <div class="move-control">
          <div class="move-control-up"><img src="icon/up.svg" alt="Yukarı" class="icon" data-icon-name="up"></div>
          <div class="move-control-down"><img src="icon/down.svg" alt="Aşağı" class="icon" data-icon-name="down"></div>
        </div>
        <input type="text" class="alliance-name" placeholder="İttifak Adı" value="${name}">
        <button type="button" class="delete-btn" title="İttifakı Kaldır">
          <img src="icon/remove.svg" alt="" class="icon" data-icon-name="remove">
        </button>
      </div>
      <div class="alliance-parties-container"></div>
    `;
    div.querySelector('.alliance-name').addEventListener('input',calculate);
    div.querySelector('.delete-btn').addEventListener('click',()=>{
      const alliance = div;
      const mainContainer = document.getElementById('main-container');
      const alliancePartiesContainer = alliance.querySelector('.alliance-parties-container');
      const parties = Array.from(alliancePartiesContainer.children);

      parties.forEach(party => {
        party.dataset.allianceId = 'null';
        mainContainer.insertBefore(party, alliance);
      });

      alliance.remove();
      calculate();
    });
    div.querySelector('.move-control-up').addEventListener('click',()=>moveElement(div,'up'));
    div.querySelector('.move-control-down').addEventListener('click',()=>moveElement(div,'down'));
    $('#main-container').appendChild(div);
    applyThemeByIndex(themeIndex);
    calculate();
    return div;
  }

  function calculate(){
    document.getElementById('methodSubtitle').textContent = `${METHODS[currentMethodIndex]} Yöntemi`;

    const seats = parseInt($('#totalSeats').value);
    const totalVotes = Array.from(document.querySelectorAll('.party-entry .party-votes, .independent-entry .party-votes'))
      .reduce((sum,input)=>{ const v=parseVoteValue(input.value); return sum+(isNaN(v)?0:v) },0);

    if(isNaN(seats) || seats<=0 || totalVotes===0){ $('#output').innerHTML=""; return }

    const threshold = isThresholdEnabled ? parseThresholdValue($('#thresholdInput').value) : 0;
    const eligibleParties = [];
    const allCandidates = [];

    const alliances={};
    document.querySelectorAll('.alliance-entry').forEach(allianceDiv=>{
      const id=allianceDiv.dataset.allianceId;
      const name=allianceDiv.querySelector('.alliance-name').value.trim();
      alliances[id]={name,votes:0,parties:[]};
    });

    document.querySelectorAll('.party-entry').forEach(entry=>{
      const name=entry.querySelector('.party-name').value.trim();
      const votes=parseVoteValue(entry.querySelector('.party-votes').value);
      const allianceId=entry.dataset.allianceId;
      if(name && !isNaN(votes) && votes>=0){ allCandidates.push({name,votes,seats:0,allianceId,type:'party'}) }
    });

    document.querySelectorAll('.independent-entry').forEach(entry=>{
      const name=entry.querySelector('.party-name').value.trim();
      const votes=parseVoteValue(entry.querySelector('.party-votes').value);
      if(name && !isNaN(votes) && votes>=0){ allCandidates.push({name,votes,seats:0,type:'independent'}) }
    });

    allCandidates.forEach(p=>{
      if(p.type==='party' && p.allianceId!=='null' && alliances[p.allianceId]){
        alliances[p.allianceId].votes+=p.votes;
        alliances[p.allianceId].parties.push(p);
      }
    });

    const roundedThreshold = parseFloat(threshold.toFixed(2));

    allCandidates.forEach(p=>{
      if(p.type==='independent'){
        const percentage = parseFloat(((p.votes/totalVotes)*100).toFixed(2));
        if(percentage >= roundedThreshold){ eligibleParties.push(p) }
      }else{
        const alliance=alliances[p.allianceId];
        if(alliance){
          const aPerc=parseFloat(((alliance.votes/totalVotes)*100).toFixed(2));
          if(aPerc >= roundedThreshold){ eligibleParties.push(p) }
        }else{
          const percentage=parseFloat(((p.votes/totalVotes)*100).toFixed(2));
          if(percentage >= roundedThreshold){ eligibleParties.push(p) }
        }
      }
    });

    const totalEligibleVotes = eligibleParties.reduce((sum,p)=>sum+p.votes,0);

    let finalResults;
    if(METHODS[currentMethodIndex]==="Hare Kotası"){ finalResults=calculateHare(eligibleParties,seats,totalEligibleVotes) }
    else if(METHODS[currentMethodIndex]==="D'Hondt"){ finalResults=calculateDhondt(eligibleParties,seats) }
    else if(METHODS[currentMethodIndex]==="Sainte-Laguë"){ finalResults=calculateSainteLague(eligibleParties,seats) }

    if(isLimitedIndependentEnabled){
      finalResults.forEach(result => {
        if(result.type === 'independent' && result.seats > 1){
          result.seats = 1;
        }
      });
    }

    let out='<h2>Sonuçlar</h2><ul>';
    const allResults = allCandidates.map(p=>finalResults.find(r=>r.name===p.name) ?? {...p,seats:0});
    const sorted = allResults.sort((a,b)=>b.votes-a.votes);

    for(const r of sorted){
      const percentage=((r.votes/totalVotes)*100).toFixed(2);

      let partyDisplay = `<strong>${r.name}</strong> (${percentage}%)`;

      // İttifak adını parantez içinde ekle
      if (r.type === 'party' && r.allianceId && r.allianceId !== 'null' && alliances[r.allianceId]) {
          const allianceName = alliances[r.allianceId].name;
          // Format: Parti Adı (İttifak Adı) (Yüzdelik%)
          partyDisplay = `<strong>${r.name}</strong> (${allianceName}) (${percentage}%)`;
      }

      out+=`<li style="border-left:5px solid var(--primary-color);">
              <div class="party-info">
                <span>${partyDisplay}</span>
              </div>
              <span class="seat-count">${r.seats} Koltuk</span>
            </li>`;
    }
    out+='</ul>';
    out+=`<div class="total-votes">Toplam Oy: ${totalVotes.toLocaleString()}</div>`;
    $('#output').innerHTML=out;
  }

  function calculateHare(parties,seats,totalEligibleVotes){
    if(totalEligibleVotes===0) return parties.map(p=>({...p,seats:0}));
    const quota=totalEligibleVotes/seats;
    let allocatedSeats=0;
    const results = parties.map(p=>{
      const raw=p.votes/quota;
      const whole=Math.floor(raw);
      allocatedSeats+=whole;
      return {...p,seats:whole,remainder:raw-whole};
    });
    let remaining=seats-allocatedSeats;
    if(remaining<0) remaining=0;
    results.sort((a,b)=>b.remainder-a.remainder);
    for(let i=0;i<remaining;i++){ if(results[i]) results[i].seats++ }
    return results;
  }
  function calculateDhondt(parties,seats){
    const results=parties.map(p=>({...p,seats:0}));
    for(let i=0;i<seats;i++){
      let maxQ=-1, win=-1;
      results.forEach((p,idx)=>{ const q=p.votes/(p.seats+1); if(q>maxQ){ maxQ=q; win=idx } });
      if(win!==-1) results[win].seats++;
    }
    return results;
  }
  function calculateSainteLague(parties,seats){
    const results=parties.map(p=>({...p,seats:0}));
    for(let i=0;i<seats;i++){
      let maxQ=-1, win=-1;
      results.forEach((p,idx)=>{ const q=p.votes/(2*p.seats+1); if(q>maxQ){ maxQ=q; win=idx } });
      if(win!==-1) results[win].seats++;
    }
    return results;
  }

  function downloadResults(){
    const totalSeats=$('#totalSeats').value;
    const thresholdStatus=isThresholdEnabled?'Açık':'Kapalı';
    const thresholdValue=isThresholdEnabled?$('#thresholdInput').value:'';
    const calculationMethod=METHODS[currentMethodIndex];
    const themeName = THEMES[themeIndex].key;
    const limitedIndependentStatus = isLimitedIndependentEnabled ? 'Açık' : 'Kapalı';

    let content=`Toplam Koltuk Sayısı: ${totalSeats}\n`;
    content+=`Baraj Durumu: ${thresholdStatus}${thresholdValue?`, ${thresholdValue}`:''}\n`;
    content+=`Bağımsız Aday Limiti: ${limitedIndependentStatus}\n`;
    content+=`Hesaplama Yöntemi: ${calculationMethod}\n`;
    content+=`Tema: ${themeName}\n`;
    content+='---\n';

    document.querySelectorAll('#main-container > div').forEach(container=>{
      if(container.classList.contains('alliance-entry')){
        const allianceName=container.querySelector('.alliance-name').value.trim();
        const allianceId=container.dataset.allianceId;
        content+=`Alliance|${allianceName}|${allianceId}\n`;
        container.querySelectorAll('.party-entry').forEach(entry=>{
          const name=entry.querySelector('.party-name').value.trim();
          const votes=entry.querySelector('.party-votes').value;
          if(name && votes){ content+=`  Party|${name}|${votes}|${allianceId}\n` }
        });
      }else if(container.classList.contains('party-entry')){
        const name=container.querySelector('.party-name').value.trim();
        const votes=container.querySelector('.party-votes').value;
        if(name && votes){ content+=`Party|${name}|${votes}\n` }
      }else if(container.classList.contains('independent-entry')){
        const name=container.querySelector('.party-name').value.trim();
        const votes=container.querySelector('.party-votes').value;
        if(name && votes){ content+=`Independent|${name}|${votes}\n` }
      }
    });

    const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const link=document.createElement('a'); link.href=url; link.download='koltuk-hesaplayici-sonuclar.txt'; link.click();
    URL.revokeObjectURL(url);
  }

  function uploadResults(event){
    const file=event.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
      const lines=e.target.result.split('\n').filter(line=>line.trim()!=='');
      $('#main-container').innerHTML='';
      const alliances = {};

      if(lines.length>0 && lines[0].startsWith('Toplam Koltuk Sayısı:')){
        $('#totalSeats').value = lines.shift().split(':')[1].trim();
      }
      if(lines.length>0 && lines[0].startsWith('Baraj Durumu:')){
        const parts=lines.shift().split(':')[1].trim().split(',').map(p=>p.trim());
        const status=parts[0]; const value=parts[1]||'';
        isThresholdEnabled=(status==='Açık');
        if(isThresholdEnabled){
          document.getElementById('thresholdInput').disabled=false; document.getElementById('thresholdInput').value=value;
        }else{
          document.getElementById('thresholdInput').disabled=true; storedThresholdValue=value; document.getElementById('thresholdInput').value='';
        }
        renderThresholdButton();
      }
      if(lines.length>0 && lines[0].startsWith('Bağımsız Aday Limiti:')){
        const status = lines.shift().split(':')[1].trim();
        isLimitedIndependentEnabled = (status === 'Açık');
        renderLimitedIndependentButton();
      }
      if(lines.length>0 && lines[0].startsWith('Hesaplama Yöntemi:')){
        const methodName=lines.shift().split(':')[1].trim();
        const idx=METHODS.indexOf(methodName);
        if(idx!==-1){ currentMethodIndex=idx; document.getElementById('methodButtonText').textContent = METHODS[idx] }
      }
      if(lines.length>0 && lines[0].startsWith('Tema:')){
        const themeName = lines.shift().split(':')[1].trim();
        const idx = THEMES.findIndex(t=> t.key === themeName);
        if(idx>=0){ themeIndex=idx; applyThemeByIndex(idx) }
      }
      if(lines.length>0 && lines[0]==='---'){ lines.shift() }

      lines.forEach(line=>{
        const parts=line.split('|').map(p=>p.trim());
        if(parts[0]==='Alliance' && parts.length>=3){
          const allianceName=parts[1]; const allianceId=parts[2];
          const allianceDiv = addAlliance(allianceName,allianceId);
          alliances[allianceId] = allianceDiv;
        } else if(parts[0]==='Party' && parts.length>=3){
          const name=parts[1]; const votes=parts[2];
          let allianceId = null;
          if (parts[0].length === 5) { // '  Party' for alliance
              allianceId = parts[parts.length - 1];
          } else if (parts.length > 3) { // old format compatibility (Party|name|votes|color|allianceId)
              allianceId = parts.length > 3 ? parts[3] : null;
          }
          addParty(name, votes, allianceId);
        } else if(parts[0]==='Independent' && parts.length>=3){
          const name=parts[1]; const votes=parts[2];
          addIndependent(name,votes);
        }
      });

      calculate();
    };
    reader.readAsText(file);
  }

  function renderThresholdButton(){
    const btn = document.getElementById('thresholdButton');
    const label = document.getElementById('thresholdLabel');
    const icon = btn.querySelector('.icon');
    label.textContent = `Baraj: ${isThresholdEnabled ? 'Açık' : 'Kapalı'}`;
    btn.classList.toggle('active', isThresholdEnabled);
    const isLightMode = document.documentElement.classList.contains('light-mode');
    if (isLightMode && !isThresholdEnabled) {
      icon.src = 'icon/token-light.svg';
    } else {
      icon.src = 'icon/token.svg';
    }
  }

  function renderLimitedIndependentButton(){
    const btn = document.getElementById('limitedIndependentButton');
    const label = document.getElementById('limitedIndependentLabel');
    const icon = btn.querySelector('.icon');
    label.textContent = `Bağımsız Limit: ${isLimitedIndependentEnabled ? 'Açık' : 'Kapalı'}`;
    btn.classList.toggle('active', isLimitedIndependentEnabled);
    const isLightMode = document.documentElement.classList.contains('light-mode');
    if (isLightMode && !isLimitedIndependentEnabled) {
      icon.src = 'icon/token-light.svg';
    } else {
      icon.src = 'icon/token.svg';
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('themeButton').addEventListener('click',()=>{
      themeIndex=(themeIndex+1)%THEMES.length;
      applyThemeByIndex(themeIndex);
    });

    applyThemeByIndex(themeIndex);

    document.getElementById('methodButton').addEventListener('click', ()=>{
      currentMethodIndex = (currentMethodIndex + 1) % METHODS.length;
      document.getElementById('methodButtonText').textContent = METHODS[currentMethodIndex];
      calculate();
    });

    document.getElementById('thresholdButton').addEventListener('click',()=>{
      isThresholdEnabled=!isThresholdEnabled;
      if(isThresholdEnabled){
        document.getElementById('thresholdInput').disabled=false;
        document.getElementById('thresholdInput').value=storedThresholdValue;
      }else{
        document.getElementById('thresholdInput').disabled=true;
        storedThresholdValue=document.getElementById('thresholdInput').value;
        document.getElementById('thresholdInput').value='';
      }
      renderThresholdButton();
      calculate();
    });

    document.getElementById('limitedIndependentButton').addEventListener('click', ()=>{
      isLimitedIndependentEnabled = !isLimitedIndependentEnabled;
      renderLimitedIndependentButton();
      calculate();
    });

    document.getElementById('totalSeats').addEventListener('input',calculate);
    document.getElementById('thresholdInput').addEventListener('input',calculate);

    document.getElementById('addPartyBtn').addEventListener('click',()=>addParty());
    document.getElementById('addIndBtn').addEventListener('click',()=>addIndependent());
    document.getElementById('addAllBtn').addEventListener('click',()=>addAlliance());

    document.getElementById('dlBtn').addEventListener('click',downloadResults);
    document.getElementById('ulBtn').addEventListener('click',()=>document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change',uploadResults);

    renderThresholdButton();
    renderLimitedIndependentButton();
  });
</script>
</body>
</html>